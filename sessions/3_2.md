# 第3回 その2

## SQL勉強会

### グループ単位で集計する

##### 例題1:

_都道府県別にそれぞれ何人ずつ顧客がいるのかを教えてくれ_

`GROUP BY`句を使って、グループ化（グルーピング）を行います。  
`GROUP BY`とは、ある列に対して同じ値ごとにひとつのグループとしてまとめる動きをします。

この説明ではピンとこないと思うので、どういうような表示をさせたいのかイメージしてみましょう。  
例えば、顧客テーブルに顧客の住所情報として都道府県カラムがあるとし、下記のようなデータが入っているとします。  

| 都道府県 |
|:--------:|
| 東京     |
| 北海道   |
| 神奈川   |
| 千葉     |
| 神奈川   |
| 東京     |
| 東京     |
| 千葉     |

自社サービスを利用している人がどの都道府県の人が多いのか知りたいというのはよくある話だと思います。  
この場合、下記のように表示することができれば要件を満たせると思います。  

| 都道府県 | 件数 |
|:--------:|:----:|
| 東京     | 3    |
| 北海道   | 1    |
| 神奈川   | 2    |
| 千葉     | 2    |

列の件数を数えたい場合は`count`が使用できます。  
その時に項目をグループ化すると上記のような表示ができるというわけです。  

```sql
-- prefectural_id(都道府県ID)ごとの件数を表示する
SELECT
  prefectural_id AS '都道府県ID',
  count(*) AS '件数'
FROM
  customers
GROUP BY
  prefectural_id
;

/***
+----------------+--------+
| 都道府県ID     | 件数   |
+----------------+--------+
|              1 |      1 |
|              8 |      3 |
|             10 |      1 |
|             11 |      2 |
|             13 |     19 |
|             14 |      2 |
|             27 |      1 |
|             38 |      1 |
+----------------+--------+
8 rows in set (0.00 sec)
***/
```

グループ化のための列の指定は複数行うことができます。  
たとえば、都道府県IDと会員種別ID（個人か法人かの区別みたいなものだと思ってください）ごとに件数を数えたい場合、下記のようなSQLになります。  

```sql
-- prefectural_id(都道府県ID)とcustomer_class_id（会員種別ID）ごとの件数を表示する
SELECT
  prefectural_id AS '都道府県ID',
  customer_class_id AS '会員種別ID',
  count(*) AS '件数'
FROM
  customers
GROUP BY
  prefectural_id,
  customer_class_id
;

/***
+----------------+----------------+--------+
| 都道府県ID     | 会員種別ID     | 件数   |
+----------------+----------------+--------+
|              1 |              1 |      1 |
|              8 |              1 |      2 |
|              8 |              2 |      1 |
|             10 |              2 |      1 |
|             11 |              2 |      2 |
|             13 |              1 |      6 |
|             13 |              2 |     13 |
|             14 |              2 |      2 |
|             27 |              1 |      1 |
|             38 |              1 |      1 |
+----------------+----------------+--------+
10 rows in set (0.01 sec)
***/

-- さらに、CASE式と組み合わせてこのような表示の仕方ができます
-- 会員種別IDだとわかりにくいので、1を個人、2を法人と表示させたい
SELECT
  prefectural_id AS '都道府県ID',
  CASE
    WHEN customer_class_id = 1 THEN '個人'
    ELSE '法人'
  END AS '会員種別',
  count(*)
FROM
  customers
GROUP BY
  prefectural_id,
  CASE
    WHEN customer_class_id = 1 THEN '個人'
    ELSE '法人'
  END
;

/***
+----------------+--------------+----------+
| 都道府県ID     | 会員種別     | count(*) |
+----------------+--------------+----------+
|              1 | 個人         |        1 |
|              8 | 個人         |        2 |
|              8 | 法人         |        1 |
|             10 | 法人         |        1 |
|             11 | 法人         |        2 |
|             13 | 個人         |        6 |
|             13 | 法人         |       13 |
|             14 | 法人         |        2 |
|             27 | 個人         |        1 |
|             38 | 個人         |        1 |
+----------------+--------------+----------+
10 rows in set (0.00 sec)
***/
```

また、集合関数を使わずに単にグループ化だけを行うこともできます。  
次の例は、customersテーブルに存在するprefectural_idをユニークにする、という機能を果たします。  
同じ値ごとにグループ化されるわけですから、重複が排除された結果を得られるようになります。  

```sql
SELECT
  prefectural_id
FROM
  customers
GROUP BY
  prefectural_id
;

/***
+----------------+
| prefectural_id |
+----------------+
|              1 |
|              8 |
|             10 |
|             11 |
|             13 |
|             14 |
|             27 |
|             38 |
+----------------+
8 rows in set (0.00 sec)
***/
```

### ワンポイント

##### グループ化を行う場合SELECT文の中で許可されるのはグループ化のキーとなる列名か、集合関数のみです。

===

##### 例題2:

_employees（社員）のbloodtype（血液型）ごとの人数を調べてください_

```sql
SELECT
  bloodtype AS '血液型',
  count(*) AS '人数'
FROM
  employees
GROUP BY
  bloodtype
;

/***
 +-----------+--------+
 | 血液型    | 人数   |
 +-----------+--------+
 | A         |     11 |
 | AB        |      3 |
 | B         |      8 |
 | O         |      9 |
 +-----------+--------+
 4 rows in set (0.00 sec)
 ***/
```

##### 例題3:

_employees（社員）のbloodtype（血液型）ごとの平均身長、平均体重を調べてください_

```sql
SELECT
  bloodtype AS '血液型',
  avg(height) AS '平均身長',
  avg(weight) AS '平均体重'
FROM
  employees
GROUP BY
  bloodtype
;

/***
+-----------+--------------+--------------+
| 血液型    | 平均身長     | 平均体重     |
+-----------+--------------+--------------+
| A         |     162.0000 |      55.7273 |
| AB        |     161.0000 |      48.3333 |
| B         |     166.3750 |      60.8750 |
| O         |     168.0000 |      62.1111 |
+-----------+--------------+--------------+
4 rows in set (0.00 sec)
 ***/
```

##### 例題4:

_日付ごとの受注個数を調べてください_

受注テーブル:sales  
受注日カラム：sale_date  
受注個数カラム:quantity

```sql
SELECT
  sale_date AS '受注日',
  sum(quantity) AS '受注数量'
FROM
  sales
GROUP BY
  sales_date
;

/***
+------------+--------------+
| 受注日     | 受注数量     |
+------------+--------------+
| 2003-09-01 |            7 |
| 2003-09-02 |           11 |
| 2003-09-03 |           46 |
| 2003-09-04 |            5 |
| 2003-09-05 |            6 |
| 2003-09-06 |           80 |
| 2003-09-07 |           17 |
| 2003-09-08 |            6 |
| 2003-09-09 |          106 |
| 2003-09-11 |            4 |
| 2003-09-12 |           35 |
| 2003-09-13 |            4 |
| 2003-09-14 |           51 |
| 2003-09-15 |           90 |
| 2003-09-16 |          150 |
| 2003-09-17 |           24 |
| 2003-09-18 |            5 |
| 2003-09-19 |            3 |
| 2003-09-21 |            9 |
| 2003-09-22 |           12 |
| 2003-09-23 |           17 |
| 2003-09-24 |            7 |
| 2003-09-25 |            3 |
| 2003-09-26 |           60 |
| 2003-09-27 |           10 |
| 2003-09-28 |            5 |
| 2003-09-29 |            3 |
| 2003-10-01 |           36 |
| 2003-10-02 |            3 |
| 2003-10-03 |            5 |
| 2003-10-04 |          108 |
| 2003-10-05 |           54 |
| 2003-10-06 |          110 |

...

329 rows in set (0.00 sec)
***/
```

